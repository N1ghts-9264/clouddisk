<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>访问分享 - HiJDK Cloud Drive</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.staticfile.org/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        :root {
            --brand-blue: #0d6efd;
            --bg-light: #f8f9fa;
        }
        
        body { 
            background: var(--bg-light);
            min-height: 100vh;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        /* 顶部导航 */
        .navbar {
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 1000;
            height: 64px;
        }
        .navbar-brand {
            font-weight: 700;
            color: var(--brand-blue) !important;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .share-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }
        
        .share-card {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            max-width: 650px;
            width: 100%;
        }
        
        .card-header-custom {
            background: linear-gradient(to bottom, #fafbfc 0%, #ffffff 100%);
            border-bottom: 2px solid #e8eaed;
            padding: 25px 30px;
        }
        
        .card-header-custom h4 {
            font-weight: 700;
            font-size: 1.4rem;
            color: #1a1f2c;
            margin-bottom: 8px;
        }
        
        .card-header-custom p {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 0;
        }
        
        .card-body-custom {
            padding: 35px;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.875rem;
            margin-bottom: 8px;
        }
        
        .input-group {
            border-radius: 8px;
            overflow: hidden;
        }
        
        .input-group-text {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-right: none;
            color: #6c757d;
        }
        
        .form-control {
            border: 1px solid #dee2e6;
            border-left: none;
            padding: 10px 14px;
        }
        
        .form-control:focus {
            border-color: var(--brand-blue);
            box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.1);
            z-index: 3;
        }
        
        .input-group:focus-within .input-group-text {
            border-color: var(--brand-blue);
            background: #e7f1ff;
            color: var(--brand-blue);
        }
        
        .btn-primary {
            background: var(--brand-blue);
            border: none;
            padding: 12px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            background: #0b5ed7;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
        }
        
        /* 文件信息卡片 - 改回白色背景 */
        .file-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #dee2e6;
            margin-bottom: 20px;
        }
        
        .file-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .file-icon-large {
            width: 50px;
            height: 50px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: var(--brand-blue);
        }
        
        .file-card-body h5 {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0;
            color: #212529;
        }
        
        .file-card-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        
        .file-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .file-meta-item i {
            color: var(--brand-blue);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-light-custom {
            background: var(--brand-blue);
            color: white;
            border: none;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .btn-light-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
            background: #0b5ed7;
            color: white;
        }
        
        .btn-light-outline {
            background: white;
            color: var(--brand-blue);
            border: 2px solid var(--brand-blue);
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .btn-light-outline:hover {
            background: var(--brand-blue);
            color: white;
            transform: translateY(-2px);
        }
        
        /* 提示信息样式 */
        .code-hint {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px 15px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #856404;
        }
        
        /* 文件图标颜色 */
        .icon-image { color: #17a2b8; }
        .icon-video { color: #e83e8c; }
        .icon-audio { color: #6f42c1; }
        .icon-document { color: #0d6efd; }
        .icon-pdf { color: #dc3545; }
        .icon-archive { color: #28a745; }
        .icon-code { color: #fd7e14; }
        .icon-default { color: #6c757d; }
    </style>
</head>
<body>

<!-- 顶部导航条 -->
<nav class="navbar navbar-expand-lg navbar-light px-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="/index">
            <i class="bi bi-cloud-check-fill fs-3"></i>
            <span>HiJDK Cloud Drive</span>
        </a>
    </div>
</nav>

<div class="share-container">
    <div class="share-card">
        <div class="card-header-custom">
            <h4>
                <i class="bi bi-share me-2" style="color: var(--brand-blue);"></i>访问分享
            </h4>
            <p>输入提取码即可获取文件</p>
        </div>
        
        <div class="card-body-custom">
            <div class="mb-3">
                <label class="form-label">分享 ID</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
                    <input type="number" id="visitShareId" class="form-control" placeholder="输入分享 ID">
                </div>
            </div>
            
            <div class="mb-4">
                <label class="form-label">提取码</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
                    <input type="text" id="visitShareCode" class="form-control" maxlength="8" placeholder="输入提取码">
                </div>
                <div class="code-hint">
                    <i class="bi bi-info-circle me-1"></i>提示：提取码大小写不敏感，输入任意大小写均可
                </div>
            </div>
            
            <button id="btnReceiveShare" class="btn btn-primary w-100">
                <i class="bi bi-arrow-down-circle me-2"></i>接收分享
            </button>
            
            <!-- 结果区域 - 改用文件卡片 -->
            <div id="receiveResult" class="mt-4" style="display:none;">
                <div class="file-card">
                    <div class="file-card-header">
                        <div class="file-icon-large" id="rr_icon">
                            <i class="bi bi-file-earmark"></i>
                        </div>
                        <div class="file-card-body flex-fill">
                            <h5 id="rr_filename">文件名</h5>
                        </div>
                    </div>
                    
                    <div class="file-card-meta">
                        <div class="file-meta-item">
                            <i class="bi bi-hdd"></i>
                            <span id="rr_size">0 KB</span>
                        </div>
                        <div class="file-meta-item">
                            <i class="bi bi-person"></i>
                            <span id="rr_user">分享者</span>
                        </div>
                        <div class="file-meta-item" id="rr_type_container">
                            <i class="bi bi-file-earmark"></i>
                            <span id="rr_type">文件</span>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button id="rr_download" class="btn btn-light-custom flex-fill">
                            <i class="bi bi-download me-1"></i>下载
                        </button>
                        <button id="rr_preview" class="btn btn-light-outline flex-fill">
                            <i class="bi bi-eye me-1"></i>预览
                        </button>
                    </div>
                    
                    <!-- 已登录用户专属：转存按钮 -->
                    <div id="userButtons" style="display:none;">
                        <button id="rr_save" class="btn btn-light-custom w-100 mt-2">
                            <i class="bi bi-cloud-arrow-down me-1"></i>转存到我的网盘
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="msgArea" class="mt-3" style="min-height:28px;"></div>
        </div>
    </div>
</div>

<script src="/js/jquery.min.js"></script>
<script>
    // 全局变量存储当前文件信息
    let currentFileInfo = null;
    let isUserLoggedIn = false;
    
    // 如果访问以 /share/{id} 形式打开，本页会尝试从 URL 中读取 shareId
    $(function () {
        const path = window.location.pathname || '';
        const match = path.match(/\/share\/(\d+)/);
        if (match) {
            $('#visitShareId').val(match[1]);
        }
        
        // 检测登录状态
        checkLoginStatus();

        $('#btnReceiveShare').on('click', function () {
            const sid = $('#visitShareId').val();
            const code = $('#visitShareCode').val();
            if (!sid) return $('#msgArea').html('<div class="alert alert-warning small mb-0"><i class="bi bi-exclamation-triangle me-1"></i>请输入分享 ID</div>');
            if (!code) return $('#msgArea').html('<div class="alert alert-warning small mb-0"><i class="bi bi-exclamation-triangle me-1"></i>请输入提取码</div>');

            $('#msgArea').html('<div class="text-muted small"><span class="spinner-border spinner-border-sm me-2"></span>正在验证...</div>');
            $('#btnReceiveShare').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>验证中...');
            $('#receiveResult').hide();
            // 1. 获取分享信息
            $.get('/api/share/info/' + sid, function (res) {
                if (!(res && res.code === 200 && res.data)) {
                    $('#msgArea').html('<div class="alert alert-danger small mb-0"><i class="bi bi-x-circle me-1"></i>获取分享信息失败：' + (res ? res.msg : '未知错误') + '</div>');
                    $('#btnReceiveShare').prop('disabled', false).html('<i class="bi bi-download me-2"></i>接收分享');
                    return;
                }
                const d = res.data;
                // 2. 校验提取码以获得临时 token
                $.ajax({
                    url: '/api/share/check',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ shareId: Number(sid), code: code }),
                    success: function (res2) {
                        if (!(res2 && res2.code === 200 && res2.data)) {
                            $('#msgArea').html('<div class="alert alert-danger small mb-0"><i class="bi bi-x-circle me-1"></i>提取码校验失败：' + (res2 ? res2.msg : '未知错误') + '</div>');
                            $('#btnReceiveShare').prop('disabled', false).html('<i class="bi bi-download me-2"></i>接收分享');
                            return;
                        }
                        const token = res2.data;
                        // 成功：将收到的文件信息以最简 UI 显示，并把该接收记录保存到 sessionStorage（可在“我的分享”页看到）
                        const rec = {
                            shareId: d.shareId || sid,
                            fileId: d.fileId,
                            filename: d.filename || ('file_' + d.fileId),
                            fileSize: d.fileSize || 0,
                            shareUser: d.shareUser || '',
                            token: token
                        };
                        
                        // 识别文件类型和图标
                        const ext = (rec.filename.split('.').pop() || '').toLowerCase();
                        const iconInfo = getFileIconInfo(ext);
                        
                        // 更新文件信息卡片
                        $('#rr_filename').text(rec.filename);
                        $('#rr_size').text(formatFileSize(rec.fileSize));
                        $('#rr_user').text(rec.shareUser || '匿名用户');
                        $('#rr_type').text(iconInfo.typeName);
                        
                        // 更新图标
                        $('#rr_icon').html('<i class="bi ' + iconInfo.icon + '"></i>');
                        
                        $('#receiveResult').show();
                        $('#msgArea').html('<div class="alert alert-success small mb-0"><i class="bi bi-check-circle me-1"></i>接收成功！现在可以下载或预览文件</div>');
                        
                        // 保存当前文件信息
                        currentFileInfo = rec;
                        
                        // 隐藏接收按钮，显示结果区
                        $('#btnReceiveShare').hide();
                        
                        // 隐藏转存按钮(默认)
                        $('#userButtons').hide();
                        
                        // 在显示结果前,重新检查登录状态
                        checkLoginStatus().then(function() {
                            // 根据登录状态显示相应按钮
                            if (isUserLoggedIn) {
                                $('#userButtons').show();
                            }
                        });
                        
                        // 重置按钮状态(不再需要,已隐藏)
                        // 绑定操作按钮
                        $('#rr_preview').off('click').on('click', function () {
                            if (!rec.fileId) return alert('无效的 fileId');
                            let url = '/api/file/download/' + rec.fileId + '?token=' + encodeURIComponent(rec.token);
                            window.open(url, '_blank');
                        });

                        $('#rr_download').off('click').on('click', function () {
                            if (!rec.fileId) return alert('无效的 fileId');
                            let url = '/api/file/download/' + rec.fileId + '?token=' + encodeURIComponent(rec.token);
                            fetch(url).then(function (res) {
                                if (!res.ok) throw new Error('服务器返回 ' + res.status);
                                const disposition = res.headers.get('Content-Disposition') || '';
                                let filename = rec.filename || ('file_' + rec.fileId);
                                const m = /filename\*?=([^;]+)/i.exec(disposition);
                                if (m) {
                                    let raw = m[1].trim(); raw = raw.replace(/^UTF-8''/, '').replace(/^"|"$/g, '');
                                    try { filename = decodeURIComponent(raw); } catch (e) { filename = raw; }
                                }
                                return res.blob().then(function (blob) { return { blob: blob, filename: filename }; });
                            }).then(function (obj) {
                                const blobUrl = URL.createObjectURL(obj.blob);
                                const a = document.createElement('a'); a.href = blobUrl; a.download = obj.filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(function () { URL.revokeObjectURL(blobUrl); }, 1000);
                            }).catch(function (err) { alert('下载失败：' + err.message); });
                        });

                    },
                    error: function (xhr) {
                        let msg = xhr.responseJSON && xhr.responseJSON.msg ? xhr.responseJSON.msg : xhr.statusText;
                        
                        // 优化错误提示
                        if (msg.includes('过期') || msg.includes('expired')) {
                            msg = '分享已过期，无法访问。请联系分享者重新分享。';
                        } else if (msg.includes('提取码') || msg.includes('code')) {
                            msg = '提取码错误，请检查后重试。';
                        }
                        
                        $('#msgArea').html('<div class="alert alert-danger small mb-0"><i class="bi bi-x-circle me-1"></i>' + msg + '</div>');
                        $('#btnReceiveShare').prop('disabled', false).html('<i class="bi bi-arrow-down-circle me-2"></i>接收分享');
                    }
                });

            }).fail(function (xhr) {
                let msg = xhr.responseJSON && xhr.responseJSON.msg ? xhr.responseJSON.msg : xhr.statusText;
                
                // 优化错误提示
                if (xhr.status === 404) {
                    msg = '分享不存在或已被删除。';
                } else if (msg.includes('过期') || msg.includes('expired')) {
                    msg = '分享已过期，无法访问。';
                }
                
                $('#msgArea').html('<div class="alert alert-danger small mb-0"><i class="bi bi-x-circle me-1"></i>' + msg + '</div>'); 
                $('#btnReceiveShare').prop('disabled', false).html('<i class="bi bi-arrow-down-circle me-2"></i>接收分享'); 
            });
       });
    });
    
    // 检测登录状态(使用Promise保证完成)
    function checkLoginStatus() {
        return $.ajax({
            url: '/api/user/info',
            type: 'GET'
        }).then(function(res) {
            if (res && res.code === 200) {
                isUserLoggedIn = true;
                console.log('用户已登录');
            } else {
                isUserLoggedIn = false;
                console.log('用户未登录');
            }
        }).catch(function() {
            isUserLoggedIn = false;
            console.log('用户未登录(请求失败)');
        });
    }
    
    // 转存按钮事件
    $(document).on('click', '#rr_save', function() {
        if (!currentFileInfo || !currentFileInfo.fileId) {
            alert('文件信息不完整');
            return;
        }
        
        const $btn = $(this);
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>转存中...');
        
        $.ajax({
            url: '/api/file/save-share',
            type: 'POST',
            data: {
                fileId: currentFileInfo.fileId,
                targetParentId: 0 // 默认保存到根目录
            },
            success: function(res) {
                console.log('转存响应:', res); // 调试日志
                if (res && res.code === 200) {
                    $('#msgArea').html('<div class="alert alert-success small mb-0"><i class="bi bi-check-circle me-1"></i>转存成功！文件已保存到"我的文件"，请到"我的分享"页面查看转存记录</div>');
                    $btn.html('<i class="bi bi-check-circle me-1"></i>已转存');
                                
                    console.log('当前文件信息:', currentFileInfo); // 调试日志
                                        
                    // 保存转存记录到 localStorage（改为跨标签页共享）
                    const savedListJson = localStorage.getItem('savedFilesList') || '[]';
                    console.log('读取的 localStorage:', savedListJson); // 调试日志
                                
                    let savedList = [];
                    try {
                        savedList = JSON.parse(savedListJson);
                    } catch(e) {
                        console.error('解析 JSON 失败:', e);
                        savedList = [];
                    }
                                
                    // 添加新记录（避免重复）
                    const isDuplicate = savedList.some(item => 
                        item.fileId === currentFileInfo.fileId && 
                        item.shareId === currentFileInfo.shareId
                    );
                                
                    console.log('是否重复:', isDuplicate); // 调试日志
                                
                    if (!isDuplicate) {
                        const newRecord = {
                            fileId: currentFileInfo.fileId,
                            filename: currentFileInfo.filename,
                            fileType: getFileExtension(currentFileInfo.filename),
                            shareId: currentFileInfo.shareId,
                            shareUser: currentFileInfo.shareUser,
                            saveTime: new Date().toISOString()
                        };
                                    
                        console.log('添加新记录:', newRecord); // 调试日志
                                    
                        savedList.push(newRecord);
                                    
                        const newJson = JSON.stringify(savedList);
                        localStorage.setItem('savedFilesList', newJson);
                                                
                        console.log('转存记录已保存到 localStorage:', savedList);
                        console.log('验证保存:', localStorage.getItem('savedFilesList'));
                    } else {
                        console.log('记录已存在，跳过');
                    }
                } else {
                    $('#msgArea').html('<div class="alert alert-danger small mb-0"><i class="bi bi-x-circle me-1"></i>转存失败：' + (res.msg || '未知错误') + '</div>');
                    $btn.prop('disabled', false).html('<i class="bi bi-cloud-arrow-down me-1"></i>转存到我的网盘');
                }
            },
            error: function(xhr) {
                const msg = (xhr.responseJSON && xhr.responseJSON.msg) || xhr.statusText || '网络错误';
                $('#msgArea').html('<div class="alert alert-danger small mb-0"><i class="bi bi-x-circle me-1"></i>转存失败：' + msg + '</div>');
                $btn.prop('disabled', false).html('<i class="bi bi-cloud-arrow-down me-1"></i>转存到我的网盘');
            }
        });
    });
        
    // 获取文件扩展名
    function getFileExtension(filename) {
        if (!filename) return '';
        const parts = filename.split('.');
        return parts.length > 1 ? parts[parts.length - 1] : '';
    }
    
    // 格式化文件大小
    function formatFileSize(bytes) {
        if (!bytes || bytes === 0) return '0 B';
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
    }
    
    // 获取文件图标信息
    function getFileIconInfo(ext) {
        const extLower = ext.toLowerCase();
        
        // 图片
        if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp'].includes(extLower)) {
            return { icon: 'bi-file-earmark-image', typeName: '图片', colorClass: 'icon-image' };
        }
        // 视频
        if (['mp4', 'avi', 'mkv', 'mov', 'wmv', 'flv', 'webm'].includes(extLower)) {
            return { icon: 'bi-file-earmark-play', typeName: '视频', colorClass: 'icon-video' };
        }
        // 音频
        if (['mp3', 'wav', 'flac', 'aac', 'ogg', 'wma'].includes(extLower)) {
            return { icon: 'bi-file-earmark-music', typeName: '音频', colorClass: 'icon-audio' };
        }
        // 文档
        if (['doc', 'docx', 'txt', 'rtf', 'odt'].includes(extLower)) {
            return { icon: 'bi-file-earmark-text', typeName: '文档', colorClass: 'icon-document' };
        }
        // PDF
        if (extLower === 'pdf') {
            return { icon: 'bi-file-earmark-pdf', typeName: 'PDF', colorClass: 'icon-pdf' };
        }
        // 表格
        if (['xls', 'xlsx', 'csv', 'ods'].includes(extLower)) {
            return { icon: 'bi-file-earmark-spreadsheet', typeName: '表格', colorClass: 'icon-document' };
        }
        // PPT
        if (['ppt', 'pptx', 'odp'].includes(extLower)) {
            return { icon: 'bi-file-earmark-slides', typeName: '演示文稿', colorClass: 'icon-document' };
        }
        // 压缩文件
        if (['zip', 'rar', '7z', 'tar', 'gz', 'bz2'].includes(extLower)) {
            return { icon: 'bi-file-earmark-zip', typeName: '压缩包', colorClass: 'icon-archive' };
        }
        // 代码文件
        if (['js', 'java', 'py', 'cpp', 'c', 'h', 'css', 'html', 'xml', 'json', 'sql', 'php', 'go', 'ts'].includes(extLower)) {
            return { icon: 'bi-file-earmark-code', typeName: '代码', colorClass: 'icon-code' };
        }
        // 默认
        return { icon: 'bi-file-earmark', typeName: '文件', colorClass: 'icon-default' };
    }

    function fetchShareInfo(shareId) {
        $('#msgArea').empty();
        $('#shareInfoArea').hide();
        $.get('/api/share/info/' + shareId, function (res) {
            if (res.code === 200 && res.data) {
                const d = res.data;
                $('#si_filename').text(d.filename);
                $('#si_meta').text('大小：' + (d.fileSize || 0) + ' 字节 · 分享者：' + (d.shareUser || '匿名') + ' · 已过期：' + (d.expired ? '是' : '否'));
                $('#shareInfoArea').show();
                // 设置 data-fileid
                $('#btnPreview').data('fileid', d.fileId);
                $('#btnDownload').data('fileid', d.fileId).data('token', '');
                // 根据文件类型决定是否启用预览（仅图片/视频）
                // 这里我们尽量允许在线浏览（浏览器会根据 Content-Type 决定）
                $('#btnPreview').prop('disabled', true);
                // 下载按钮默认不可用，需校验提取码后启用
                $('#btnDownload').prop('disabled', true);
                // 清理可能存在的 token
                $('#btnPreview').data('token', '');
                $('#btnDownload').data('token', '');
            } else {
                $('#msgArea').html('<div class="alert alert-danger p-2">获取分享信息失败：' + res.msg + '</div>');
            }
        }).fail(function (xhr) { $('#msgArea').html('<div class="alert alert-danger p-2">获取失败：' + (xhr.responseJSON && xhr.responseJSON.msg ? xhr.responseJSON.msg : xhr.statusText) + '</div>'); });
    }

    function enableDownload(token) {
        $('#btnDownload').data('token', token).prop('disabled', false);
        $('#msgArea').append('<div class="mt-2 small text-muted">现在可以使用“下载”或“在线浏览”。如果下载被阻止，可能需要使用提取码后再尝试或登录。</div>');
    }
</script>
</body>
</html>