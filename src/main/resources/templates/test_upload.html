<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>存储模块测试 - CloudDisk</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <script th:src="@{/js/jquery.min.js}"></script>
</head>
<body class="container mt-5">
    <h3>角色 B：存储核心功能测试</h3>
    <hr>

    <!-- 父目录设置 -->
    <div class="card p-4 mb-4">
        <h5>父目录设置</h5>
        <div class="mb-3">
            <label class="form-label">选择父目录ID (根目录传0):</label>
            <input type="number" id="parentId" class="form-control" value="0">
        </div>
    </div>

    <!-- 单文件上传 -->
    <div class="card p-4 mb-4">
        <h5>单文件上传测试</h5>
        <div class="mb-3">
            <input type="file" id="fileInput" class="form-control">
        </div>
        <button class="btn btn-primary" onclick="uploadFile()">开始上传</button>
        <div id="singleResult" class="mt-3 alert d-none"></div>
    </div>

    <!-- 批量上传 -->
    <div class="card p-4 mb-4">
        <h5>批量上传测试</h5>
        <div class="mb-3">
            <input type="file" id="batchFileInput" class="form-control" multiple>
        </div>
        <button class="btn btn-success" onclick="uploadBatch()">批量上传</button>
        <div id="batchResult" class="mt-3 alert d-none"></div>
    </div>

    <script>
        // 单文件上传
        function uploadFile() {
            let file = $('#fileInput')[0].files[0];
            let parentId = $('#parentId').val();

            if (!file) {
                alert("请选择文件");
                return;
            }

            let formData = new FormData();
            formData.append("file", file);
            formData.append("parentId", parentId);

            $.ajax({
                url: '/api/file/upload',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                dataType: 'json', // 确保解析 JSON
                success: function(res) {
                    if (res.code === 200) { // 200 表示真正成功
                        $('#singleResult')
                            .removeClass('d-none alert-danger')
                            .addClass('alert-success')
                            .text("✅ 上传成功！文件ID: " + (res.data.file_id || res.data));
                    } else {
                        // code !== 200 时，显示失败信息
                        $('#singleResult')
                            .removeClass('d-none alert-success')
                            .addClass('alert-danger')
                            .text("❌ 上传失败：" + res.msg)
                            .show();
                    }
                }
                ,
                error: function(err) {
                    let msg = "未知错误";

                    // 尝试从 JSON 获取
                    if (err.responseJSON && err.responseJSON.msg) {
                        msg = err.responseJSON.msg;
                    } 
                    // 如果不是 JSON，则用原始响应文本
                    else if (err.responseText) {
                        msg = err.responseText;
                        // 只取简短信息，不显示整个 HTML
                        msg = msg.replace(/<[^>]+>/g, '').trim().substring(0, 200);
                    }

                    $('#singleResult')
                        .removeClass('d-none alert-success')
                        .addClass('alert-danger')
                        .text("❌ 上传失败：" + msg)
                        .show(); // 强制显示
                }


            
            });
        }

        // 批量上传
        function uploadBatch() {
            let files = $('#batchFileInput')[0].files;
            let parentId = $('#parentId').val();

            if (files.length === 0) {
                alert("请选择文件");
                return;
            }

            let formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append("files", files[i]);
            }
            formData.append("parentId", parentId);

            $.ajax({
                url: '/api/file/upload/batch',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                dataType: 'json',
                success: function(res) {
                    // 判断业务状态码
                    if (res.code === 200) {
                        $('#batchResult')
                            .removeClass('d-none alert-danger')
                            .addClass('alert-success')
                            .text("✅ 批量上传成功，文件IDs: " + res.data.join(','))
                            .show();
                    } else {
                        $('#batchResult')
                            .removeClass('d-none alert-success')
                            .addClass('alert-danger')
                            .text("❌ 批量上传失败：" + res.msg)
                            .show();
                    }
                },
                error: function(err) {
                    let msg = "未知错误";

                    if (err.responseJSON && err.responseJSON.msg) {
                        msg = err.responseJSON.msg;
                    } else if (err.responseText) {
                        msg = err.responseText.replace(/<[^>]+>/g, '').trim().substring(0, 200);
                    }

                    $('#batchResult')
                        .removeClass('d-none alert-success')
                        .addClass('alert-danger')
                        .text("❌ 批量上传失败：" + msg)
                        .show();
                }
            });
        }

    </script>
</body>
</html>
